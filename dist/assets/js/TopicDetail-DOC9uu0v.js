import{r as h,u as V,j as e,R as te,k as se,F as oe}from"./react-vendor-CHNrpsCK.js";import{P as F,b as ne}from"./vendor-DsLnOOP7.js";import{j as W,k as q,u as z,B as ae,T as ce,A as U,P as re}from"./index-HN6HrZ4S.js";import{t as ie,u as le,d as de,b as ue}from"./topicsService-B4rxDbaD.js";import{B as he}from"./BackArrow-DMkPAoQd.js";async function H(a){try{const{data:s}=await W.get(q.POSTS.GET_BY_TOPIC(a));return s}catch(s){throw s}}async function pe({topicId:a,content:s},p){try{return(await W.post(`${q.POSTS.BASE}/add`,{topicId:a,content:s},{headers:{Authorization:`Bearer ${p}`}})).data}catch(j){throw j}}async function me(a,s){try{return(await W.delete(`${q.POSTS.BASE}/${a}`,{headers:{Authorization:`Bearer ${s}`}})).data}catch(p){throw p}}const xe="_9ZAx7",ge="r-iCU",_e="Vy6Bo",je="ngHz9",Te="nmNt8",fe="cEON2",be="tp7Ly",ye="mpQkB",ke="qbyKy",Be="C7XPe",Ne="J3FlS",i={modalBackground:xe,modalContent:ge,modalTitle:_e,form:je,formField:Te,errorText:fe,toolsRow:be,buttonRow:ye,cancelButton:ke,submitButton:Be,toolButton:Ne};function K({topicId:a,onClose:s,onSuccess:p}){const{user:j}=z(),[x,N]=h.useState(""),[f,$]=h.useState(null),[w,b]=h.useState(null),[C,P]=h.useState(!1),g=h.useRef(),{t:l}=V();h.useEffect(()=>{const d=n=>{n.key==="Escape"&&s()};return document.addEventListener("keydown",d),()=>document.removeEventListener("keydown",d)},[s]);const S=async d=>{if(d.preventDefault(),b(null),!x){b(l("PostModal.Error.RequiredField"));return}if(!f){b(l("PostModal.Error.CaptchaRequired"));return}try{P(!0),await pe({topicId:a,content:x,recaptchaToken:f},j.token),p(),s()}catch{b(l("PostModal.Error.AdditionFailed"))}finally{P(!1)}},y=(d,n="")=>{const T=g.current;if(!T)return;const v=T.selectionStart,A=T.selectionEnd,R=x.slice(0,v),k=x.slice(v,A),I=x.slice(A),L=`[${d}]${k||n}[/${d}]`;N(R+L+I),setTimeout(()=>{T.focus();const O=k?k.length:n.length,D=v+d.length+2,M=D+O;T.setSelectionRange(D,M)},0)};return e.jsx("div",{className:i.modalBackground,children:e.jsxs("div",{className:i.modalContent,children:[e.jsx("h2",{className:i.modalTitle,children:l("PostModal.AnswerToTopic")}),w&&e.jsx("p",{className:i.errorText,children:w}),e.jsxs("form",{onSubmit:S,className:i.form,children:[e.jsxs("div",{className:i.formField,children:[e.jsxs("div",{className:i.toolsRow,children:[e.jsxs("button",{type:"button",className:i.toolButton,onClick:()=>y("spoiler","Texte caché"),children:["🔒 ",l("PostModal.Spoiler")]}),e.jsxs("button",{type:"button",className:i.toolButton,onClick:()=>y("b","Texte en gras"),children:["🅱️ ",l("PostModal.Bold")]}),e.jsx("button",{type:"button",className:i.toolButton,onClick:()=>y("i","Texte en italique"),children:l("PostModal.Italic")}),e.jsx("button",{type:"button",className:i.toolButton,onClick:()=>y("u","Texte souligné"),children:l("PostModal.Underline")}),e.jsx("button",{type:"button",className:i.toolButton,onClick:()=>y("s","Texte barré"),children:l("PostModal.Strikethrough")})]}),e.jsx("textarea",{ref:g,placeholder:l("PostModal.MessagePlaceholder"),rows:5,value:x,onChange:d=>N(d.target.value)})]}),e.jsx("div",{className:i.formField,children:e.jsx(te,{sitekey:"6LeySBQrAAAAAP6T4OxTqoVWFOEkBnp7Mfntsnes",onChange:d=>$(d)})}),e.jsxs("div",{className:i.buttonRow,children:[e.jsx("button",{type:"button",className:i.cancelButton,onClick:s,children:l("PostModal.Cancel")}),e.jsx("button",{type:"submit",className:i.submitButton,disabled:!x||!f||C,children:l(C?"PostModal.Sending":"PostModal.Send")})]})]})]})})}K.propTypes={topicId:F.string.isRequired,onClose:F.func.isRequired,onSuccess:F.func.isRequired};const Pe="_76Qlm",Q={spoiler:Pe};function Se({content:a}){const[s,p]=h.useState(!1),x=typeof a=="string"||Array.isArray(a)&&a.every(N=>typeof N=="string")?"span":"div";return e.jsx(x,{className:Q.spoiler,onClick:()=>p(!s),children:s?a:e.jsx("span",{className:Q.clickToReveal,children:"🔒 Cliquez pour révéler"})})}const ve="YX8t6",we="_3dVIl",Ce="LbgMo",De="_2aoE-",Ee="gEfXZ",Ae="MCskf",Re="Ztt-w",Me="_0qnFy",$e="RKoZS",Ie="DqQDW",Le="BjGU9",Oe="xW6wt",Fe="M-JAy",We="Yr3Rv",qe="RE-wV",Ue="n53zV",He="agMTK",Qe="ME-3B",Ve="PLc-x",ze="_5B-9e",Ke="IIjwA",Ze="NQ0vm",Ge="u569p",Xe="kMA-E",Ye="GN61s",o={TopicDetail:ve,banner:we,main:Ce,head:De,title_container:Ee,lockedMessage:Ae,searchBar:Re,inputSearch:Me,btn_container:$e,author:Ie,post:Le,authorHead:Oe,postHead:Fe,authorContent:We,postContent:qe,Topic:Ue,avatar:He,createButton:Qe,lockButton:Ve,pinButton:ze,deleteTopicButton:Ke,backArrowWrapper:Ze,deletePostButton:Ge,up_container:Xe,up:Ye};function nt(){const{topicId:a}=se(),[s,p]=h.useState(null),[j,x]=h.useState(""),[N,f]=h.useState([]),[$,w]=h.useState(!1),[b,C]=h.useState(1),P=10,{user:g}=z(),[l,S]=h.useState(!1),[y,d]=h.useState(""),{t:n}=V(),T=N.filter(t=>t.content.toLowerCase().includes(j.toLowerCase())),v=b*P,A=v-P,R=T.slice(A,v),k=Math.ceil(T.length/P),I=t=>{t>=1&&t<=k&&C(t)};h.useEffect(()=>{async function t(){try{const m=await ue(a),E=await H(a);p(m),f(E)}catch{}}t()},[a]);const L=async()=>{try{const t=await H(a);f(t)}catch{}};if(!s)return e.jsx("h1",{children:"Chargement du topic..."});const O={backgroundImage:`url(${ae})`},D=g?.role==="admin"||g?.role==="moderator";function M(t){const m=/\[spoiler](.*?)\[\/spoiler]/gi,E=/\[b](.*?)\[\/b]/gi,Z=/\[i](.*?)\[\/i]/gi,G=/\[u](.*?)\[\/u]/gi,X=/\[s](.*?)\[\/s]/gi,Y=(J,B)=>{const u={spoiler:[],b:[],i:[],u:[],s:[]};let ee=J.replace(m,(c,r)=>(u.spoiler.push(r),`__SPOILER__${u.spoiler.length-1}__`)).replace(E,(c,r)=>(u.b.push(r),`__BOLD__${u.b.length-1}__`)).replace(Z,(c,r)=>(u.i.push(r),`__ITALIC__${u.i.length-1}__`)).replace(G,(c,r)=>(u.u.push(r),`__UNDERLINE__${u.u.length-1}__`)).replace(X,(c,r)=>(u.s.push(r),`__STRIKE__${u.s.length-1}__`));return e.jsx("div",{style:{marginBottom:"0.5em"},children:ee.split(/(__[A-Z]+__\d+__)/).map((c,r)=>{if(c.startsWith("__SPOILER__")){const _=+c.match(/\d+/)[0];return e.jsx(Se,{content:e.jsx(e.Fragment,{children:M(u.spoiler[_])})},`sp-${B}-${r}`)}if(c.startsWith("__BOLD__")){const _=+c.match(/\d+/)[0];return e.jsx("strong",{children:u.b[_]},`b-${B}-${r}`)}if(c.startsWith("__ITALIC__")){const _=+c.match(/\d+/)[0];return e.jsx("em",{children:u.i[_]},`i-${B}-${r}`)}if(c.startsWith("__UNDERLINE__")){const _=+c.match(/\d+/)[0];return e.jsx("u",{children:u.u[_]},`u-${B}-${r}`)}if(c.startsWith("__STRIKE__")){const _=+c.match(/\d+/)[0];return e.jsx("s",{children:u.s[_]},`s-${B}-${r}`)}return e.jsx("span",{children:c},`t-${B}-${r}`)})},B)};return t.split(`
`).map(Y)}return e.jsxs("div",{id:"topPage",className:o.TopicDetail,children:[e.jsx("div",{className:o.banner,style:O}),e.jsxs("main",{className:o.main,children:[l&&e.jsx(ce,{message:y}),e.jsxs("header",{className:o.head,children:[e.jsxs("section",{className:o.title_container,children:[e.jsx("div",{className:o.backArrowWrapper,children:e.jsx(he,{})}),g&&!s.locked&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>w(!0),className:o.createButton,children:n("TopicDetail.AnswerTopic")}),$&&e.jsx(K,{topicId:a,onClose:()=>w(!1),onSuccess:L})]}),g&&s.locked&&e.jsx("h3",{className:o.lockedMessage,children:n("TopicDetail.LockedMessage")}),e.jsx("h2",{children:s.title}),e.jsx("div",{className:o.searchBar,children:e.jsxs("div",{className:o.inputSearch,children:[e.jsx("input",{type:"text",value:j,onChange:t=>{x(t.target.value),C(1)},placeholder:n("TopicDetail.SearchPlaceholder")}),e.jsx("button",{type:"button",children:e.jsx(oe,{icon:ne})})]})})]}),D&&e.jsx(e.Fragment,{children:e.jsxs("aside",{className:o.btn_container,children:[e.jsx("button",{className:o.lockButton,onClick:async()=>{try{const t=await ie(s._id,g.token);p(m=>({...m,locked:t.locked}))}catch(t){alert(n("ErrorToggleLock",t))}},children:s.locked?n("TopicDetail.Unlock"):n("TopicDetail.Lock")}),e.jsx("button",{className:o.pinButton,onClick:async()=>{try{await le(s._id,g.token),p(t=>({...t,notice:!t.notice}))}catch(t){alert(n("ErrorTogglePin",t))}},children:s.notice?n("TopicDetail.Unpin"):n("TopicDetail.Pin")}),e.jsx("button",{className:o.deleteTopicButton,onClick:async()=>{if(window.confirm(n("TopicDetail.ConfirmDelete")))try{await de(s._id,g.token),d(n("TopicDetail.DeleteSuccess")),S(!0),setTimeout(()=>{S(!1),window.location.href="/Forum"},2e3)}catch(m){alert(n("TopicDetail.ErrorDelete",m))}},children:n("TopicDetail.Delete")})]})})]}),e.jsxs("section",{className:o.Topic,children:[e.jsxs("div",{className:o.author,children:[e.jsxs("div",{className:o.authorHead,children:[e.jsx("img",{src:s.authorAvatar||U,alt:"Avatar",className:o.avatar}),e.jsxs("p",{children:[e.jsxs("strong",{children:[n("TopicDetail.Author")," :"]})," ",s.authorName]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[n("TopicDetail.CreatedOn")," :"]})," ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsx("div",{className:o.authorContent,children:s.content.split(`
`).map((t,m)=>e.jsx("p",{children:t},m))})]}),e.jsxs("h3",{children:[n("TopicDetail.Replies")," :"]}),e.jsx("ul",{children:R.length>0?R.map(t=>e.jsx("li",{children:e.jsxs("div",{className:o.post,children:[e.jsxs("div",{className:o.postHead,children:[e.jsx("img",{src:t.userAvatar||U,alt:"Avatar",className:o.avatar}),e.jsx("p",{children:e.jsx("strong",{children:t.userName})}),e.jsxs("p",{children:[e.jsxs("strong",{children:[n("TopicDetail.CreatedOn")," :"]})," ",new Date(t.created_at).toLocaleDateString()]})]}),D&&e.jsx("button",{className:o.deletePostButton,onClick:async()=>{try{await me(t._id,g.token),f(m=>m.filter(E=>E._id!==t._id)),d("Post supprimé avec succès ✅"),S(!0),setTimeout(()=>S(!1),2e3)}catch{alert("Erreur lors de la suppression.")}},children:n("TopicDetail.Delete")}),e.jsx("div",{className:o.postContent,children:e.jsx("div",{children:M(t.content)})})]})},t._id)):e.jsx("p",{children:n("TopicDetail.NoReplies")})}),e.jsx("div",{className:o.up_container,children:e.jsx("a",{href:"#topPage",className:o.up,children:n("TopicDetail.BackToTop")})}),k>1&&e.jsx("div",{className:o.paginationWrapper,children:e.jsx(re,{currentPage:b,totalPages:k,onPageChange:I})})]})]})]})}export{nt as default};
