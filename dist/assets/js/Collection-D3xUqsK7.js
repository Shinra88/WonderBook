import{u as U,r,j as e,F as D,a as G}from"./react-vendor-CHNrpsCK.js";import{u as O,g as P}from"./collectionService-BcqxLn22.js";import{u as z,h as H,B as $,a as J,i as Q,T as L}from"./index-HN6HrZ4S.js";import{a as q}from"./commentService-_ed6Ovuu.js";import{f as V}from"./vendor-DsLnOOP7.js";const K="nuO0b",X="_0pR73",Z="FUTfG",ee="iSYNX",te="nkUqw",oe="oYe2h",se="pqqDH",ae="_7zacM",ne="_2cqib",le="DFEG6",h={overlay:K,modal:X,cover:Z,textarea:ee,stars:te,filledStar:oe,emptyStar:se,buttons:ae,validateButton:ne,cancelButton:le};function re({book:d,onClose:g}){const{t:p}=U(),[v,c]=r.useState(""),[x,k]=r.useState(0),[_,S]=r.useState(0),[j,I]=r.useState(!1);r.useEffect(()=>{d?.existingComment&&(c(d.existingComment.content||""),k(d.existingComment.rating||0))},[d]);const y=async()=>{if(!v.trim()){alert(p("CommentModal.EmptyComment"));return}try{I(!0),await q(d.bookId,{content:v,rating:x}),g()}catch{}finally{I(!1)}};return e.jsx("div",{className:h.overlay,children:e.jsxs("div",{className:h.modal,children:[e.jsx("h2",{children:p("CommentModal.Title",{title:d.title})}),e.jsx("img",{src:d.cover_url,alt:d.title,className:h.cover}),e.jsx("textarea",{className:h.textarea,value:v,onChange:u=>c(u.target.value),placeholder:p("CommentModal.ContentPlaceholder")}),e.jsx("div",{className:h.stars,children:[1,2,3,4,5].map(u=>e.jsx("span",{className:(_||x)>=u?h.filledStar:h.emptyStar,onClick:()=>k(u),onMouseEnter:()=>S(u),onMouseLeave:()=>S(0),children:e.jsx(D,{icon:V})},u))}),e.jsxs("div",{className:h.buttons,children:[e.jsx("button",{onClick:g,className:h.cancelButton,children:p("CommentModal.Cancel")}),e.jsx("button",{onClick:y,disabled:j,className:h.validateButton,children:p(j?"CommentModal.SubmitLoading":"CommentModal.Submit")})]})]})})}const ce="gK7cs",ie="YdA9J",de="_32n2S",ue="_2-m0D",me="s88F0",he="Ie3H-",fe="_3hqJ0",pe="_3HqhC",ke="QJlNf",be="PRUVz",Ce="ztTVs",a={Collection:ce,main:ie,head:de,bookList:ue,bookItemWrapper:me,bookStatus:he,statusItem:fe,filterToggle:pe,filterContainer:ke,radioGroup:be,uploadFieldWrapper:Ce};function Se(){const[d,g]=r.useState([]),[p,v]=r.useState(!0),[c,x]=r.useState("all"),[k,_]=r.useState(!1),[S,j]=r.useState(!1),[I,y]=r.useState(null),[u,M]=r.useState(""),[R,E]=r.useState(null),{user:N}=z(),{selectedCategories:B,selectedYear:f,selectedType:A,searchQuery:w}=H(),W={backgroundImage:`url(${$})`},{t:n}=U(),F=G();r.useEffect(()=>{N||F("/")},[N,F]);const Y=N?.role==="admin"||N?.role==="prenium";r.useEffect(()=>{async function t(){try{const s={commented:k};c==="read"&&(s.read=!0),c==="unread"&&(s.read=!1);const b=await P(s);g(b)}catch{}finally{v(!1)}}t()},[c,k]);const T=d.filter(t=>{const s=t.books;if(!s||c==="read"&&t.is_read!==!0||c==="unread"&&t.is_read===!0||k&&(!s.comments||!s.comments.some(l=>l.userId===t.userId)))return!1;let b=!0;if(B.length>0){const l=s.book_categories?.map(m=>m.categories.name)||[];b=A==="et"?B.every(m=>l.includes(m)):B.some(m=>l.includes(m))}let o=!0;if(f){const l=s.date?new Date(s.date).getFullYear():null;if(typeof f=="string"&&f.length===4)o=parseInt(f)===l;else if(typeof f=="object"&&f.start&&f.end){const m=parseInt(f.start),C=parseInt(f.end);!isNaN(m)&&!isNaN(C)&&(o=l>=m&&l<=C)}}let i=!0;if(w.trim()!==""){const l=w.toLowerCase();i=s.title?.toLowerCase().includes(l)||s.author?.toLowerCase().includes(l)}return b&&o&&i});return e.jsx("div",{className:a.Collection,style:W,children:e.jsxs("main",{className:a.main,children:[e.jsxs("header",{className:a.head,children:[e.jsx("h2",{children:n("Collection.Title")}),e.jsx("p",{children:n("Collection.NumberOfBooks",{count:T.length})}),e.jsxs("div",{className:a.filterContainer,children:[e.jsxs("label",{className:a.filterToggle,children:[n("Collection.Filters")," :"]}),e.jsxs("div",{className:a.radioGroup,children:[e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:"readStatus",value:"all",checked:c==="all",onChange:()=>x("all")})," ",n("Collection.FilterAll")]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:"readStatus",value:"read",checked:c==="read",onChange:()=>x("read")})," ",n("Collection.FilterRead")]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:"readStatus",value:"unread",checked:c==="unread",onChange:()=>x("unread")})," ",n("Collection.FilterUnread")]})]}),e.jsxs("label",{htmlFor:"commented",className:a.filterToggle,children:[e.jsx("input",{type:"checkbox",id:"commented",checked:k,onChange:()=>_(t=>!t)})," ",n("Collection.FilterCommented")]})]})]}),e.jsx("section",{className:a.bookList,children:p?e.jsxs("h1",{children:[n("Loading"),"..."]}):T.length>0?T.map(t=>{const s=t.books.comments?.find(o=>o.userId===t.userId),b=s?s.rating:0;return e.jsxs("div",{className:a.bookItemWrapper,children:[e.jsx(J,{book:{bookId:t.books.bookId,title:t.books.title,author:t.books.author,date:t.books.date,cover_url:t.books.cover_url,summary:t.books.summary,ratings:t.books.ratings||[],averageRating:b,editors:t.books.book_publishers?.map(o=>o.publishers.name)||[],categories:t.books.book_categories?.map(o=>o.categories.name)||[]},size:2}),e.jsxs("div",{className:a.bookStatus,children:[e.jsxs("div",{className:a.statusItem,children:[e.jsx("input",{type:"checkbox",checked:t.is_read,disabled:t.is_read,onChange:async()=>{if(!t.is_read)try{await O(t.books.bookId,!0),g(o=>o.map(i=>i.collectionId===t.collectionId?{...i,is_read:!0}:i))}catch{}}}),e.jsx("span",{children:n("Collection.FilterRead")})]}),Y&&!t.books.ebook_url&&e.jsxs("div",{className:a.statusItem,children:[e.jsx("button",{className:a.uploadEbookButton,onClick:()=>E(o=>o===t.collectionId?null:t.collectionId),children:R===t.collectionId?n("Collection.Cancel"):n("Collection.UploadEbook")}),R===t.collectionId&&e.jsx("div",{className:a.uploadFieldWrapper,children:e.jsx("input",{type:"file",accept:".epub",onChange:async o=>{const i=o.target.files[0];if(i)try{const l=await Q(i,t.books.bookId);if(!l)return;g(m=>m.map(C=>C.collectionId===t.collectionId?{...C,books:{...C.books,ebook_url:l}}:C)),E(null),L(n("Collection.UploadSuccess"))}catch{}}})})]}),t.is_read&&e.jsx("div",{className:a.statusItem,children:e.jsx("button",{className:a.commentButton,onClick:()=>{const o=t.books.comments?.find(i=>i.userId===t.userId);y({...t.books,existingComment:o||null,rating:o?.rating||0}),j(!0)},children:t.books.comments?.some(o=>o.userId===t.userId)?n("Collection.EditComment"):n("Collection.Commenter")})}),t.books.ebook_url&&e.jsx("div",{className:a.statusItem,children:e.jsx("button",{className:a.commentButton,onClick:()=>F(`/read/${t.books.bookId}`),children:n("Collection.ReadEbook")})})]})]},t.collectionId)}):e.jsx("h1",{children:n("Collection.NoBooksFound")})}),S&&I&&e.jsx(re,{book:I,onClose:()=>{j(!1),y(null)},onSubmit:async(t,s)=>{try{await q(I.bookId,{content:t,rating:s}),M(n("Collection.CommentSuccess")),j(!1),y(null),setTimeout(()=>M(""),3e3)}catch{}}}),u&&e.jsx(L,{message:u})]})})}export{Se as default};
